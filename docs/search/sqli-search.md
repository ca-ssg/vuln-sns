# 検索機能のSQLインジェクション

## 脆弱性の説明
検索処理で、ユーザー入力を直接SQLクエリに結合しているため、SQLインジェクションが可能です。

## 影響範囲
- データベース情報の漏洩
- 不正な検索結果の取得
- システム情報の漏洩

## 攻撃方法と手順

### 1. 基本的なSQLインジェクション攻撃

1. アプリケーションにログインします
2. 検索フォームにアクセスします
3. 検索フィールドに以下のSQLインジェクションペイロードを入力します：
   ```
   ' OR '1'='1
   ```
4. 検索ボタンをクリックします

このペイロードは、WHERE句の条件を常に真にするため、データベース内のすべての投稿が検索結果として表示されます。

### 2. UNION攻撃によるデータ抽出

1. アプリケーションにログインします
2. 検索フォームにアクセスします
3. 検索フィールドに以下のSQLインジェクションペイロードを入力します：
   ```
   ' UNION SELECT id, user_id, password FROM users --
   ```
4. 検索ボタンをクリックします

このペイロードは、UNION句を使用して、検索結果に「users」テーブルからのデータ（ユーザーIDとパスワードハッシュなど）を追加しようとします。

### 3. データベース情報を取得するSQLインジェクション

1. アプリケーションにログインします
2. 検索フォームにアクセスします
3. 検索フィールドに以下のSQLインジェクションペイロードを入力します：
   ```
   ' UNION SELECT table_name, column_name, 'info' FROM information_schema.columns WHERE table_schema = DATABASE() --
   ```
4. 検索ボタンをクリックします

このペイロードは、データベースのスキーマ情報（テーブル名とカラム名）を取得しようとします。

### 4. システム情報を取得するSQLインジェクション

1. アプリケーションにログインします
2. 検索フォームにアクセスします
3. 検索フィールドに以下のSQLインジェクションペイロードを入力します：
   ```
   ' UNION SELECT @@version, user(), database() --
   ```
4. 検索ボタンをクリックします

このペイロードは、データベースのバージョン、現在のデータベースユーザー、現在のデータベース名などのシステム情報を取得しようとします。

## 攻撃成功の確認手順

### 1. 全件取得の確認

1. 上記の基本的なSQLインジェクションペイロード（`' OR '1'='1`）を使用して検索します
2. 検索結果に、通常の検索では表示されないはずの投稿も含めて、すべての投稿が表示されていることを確認します

### 2. データ抽出の確認

1. UNION攻撃のペイロードを使用して検索します
2. 検索結果に、投稿データだけでなく、ユーザーテーブルのデータ（ユーザーIDやパスワードハッシュなど）も表示されていることを確認します

### 3. エラーメッセージからの情報漏洩の確認

1. 意図的に不正なSQLインジェクションペイロードを入力します（例：`' UNION SELECT * FROM non_existent_table --`）
2. エラーメッセージが表示される場合、そのメッセージにデータベース情報（テーブル名、カラム名、SQLクエリの構造など）が含まれていないか確認します

### 4. ブラウザの開発者ツールでのレスポンス確認

1. ブラウザの開発者ツールを開きます（F12キー）
2. 「Network」タブを選択します
3. SQLインジェクションペイロードを使用して検索します
4. 検索リクエストのレスポンスを確認し、通常の検索結果以外のデータが含まれているか確認します

## 対策方法
### 1. プリペアドステートメントの使用
```go
// 修正前（脆弱なコード）
query := fmt.Sprintf("SELECT * FROM posts WHERE content LIKE '%%%s%%'", searchTerm)

// 修正後（安全なコード）
query := "SELECT * FROM posts WHERE content LIKE ?"
searchPattern := "%" + searchTerm + "%"
rows, err := db.Query(query, searchPattern)
```

### 2. 入力値のバリデーション
```go
func validateSearchTerm(term string) error {
    // 特殊文字や制御文字のチェック
    if strings.ContainsAny(term, "'\"\\;") {
        return errors.New("invalid characters in search term")
    }
    return nil
}
```
