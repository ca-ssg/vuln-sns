# プロフィール機能のSQLインジェクション

## 脆弱性の説明
プロフィール更新処理で、ユーザー入力を直接SQLクエリに結合しているため、SQLインジェクションが可能です。

## 影響範囲
- 不正なプロフィール更新
- データベース情報の漏洩
- 他ユーザーの情報改ざん

## 攻撃方法と手順

### 1. 基本的なSQLインジェクション攻撃

1. アプリケーションにログインします
2. プロフィール更新ページにアクセスします
3. ニックネームフィールドに以下のSQLインジェクションペイロードを入力します：
   ```
   新しいニックネーム' WHERE id='admin' --
   ```
4. 更新ボタンをクリックします

このペイロードは、WHERE句の条件を操作して、他のユーザー（この場合は管理者）のプロフィール情報を更新しようとします。

### 2. 複数フィールドを同時に更新するSQLインジェクション

1. アプリケーションにログインします
2. プロフィール更新ページにアクセスします
3. ニックネームフィールドに以下のSQLインジェクションペイロードを入力します：
   ```
   新しいニックネーム', email='hacked@example.com', bio='このアカウントはハッキングされました' WHERE id='target_user' --
   ```
4. 更新ボタンをクリックします

このペイロードは、複数のフィールドを同時に更新しようとします。通常、ニックネームフィールドだけが更新されるはずですが、SQLインジェクションにより他のフィールドも更新されます。

### 3. データベース情報を取得するSQLインジェクション

1. アプリケーションにログインします
2. プロフィール更新ページにアクセスします
3. ニックネームフィールドに以下のSQLインジェクションペイロードを入力します：
   ```
   新しいニックネーム' AND (SELECT 1 FROM (SELECT COUNT(*), CONCAT(table_name, ':', column_name, ':', (SELECT SUBSTR(CONCAT(id, ':', password), 1, 50) FROM users LIMIT 1)) AS x FROM information_schema.columns WHERE table_schema = DATABASE() GROUP BY x) y) AND '1'='1
   ```
4. 更新ボタンをクリックします

このペイロードは、エラーベースのSQLインジェクションを試みます。データベースがエラーメッセージを返す場合、そのメッセージにデータベース構造やユーザー情報が含まれている可能性があります。

## 攻撃成功の確認手順

### 1. 他ユーザーのプロフィール更新の確認

1. 上記のペイロードを使用してプロフィールを更新します
2. 別のユーザーアカウント（例：admin）でログインします
3. プロフィールページにアクセスし、情報が変更されているか確認します

### 2. エラーメッセージからの情報漏洩の確認

1. 意図的に不正なSQLインジェクションペイロードを入力します（例：`' AND (SELECT * FROM non_existent_table) --`）
2. エラーメッセージが表示される場合、そのメッセージにデータベース情報（テーブル名、カラム名、SQLクエリの構造など）が含まれていないか確認します

### 3. ブラウザの開発者ツールでのレスポンス確認

1. ブラウザの開発者ツールを開きます（F12キー）
2. 「Network」タブを選択します
3. SQLインジェクションペイロードを使用してプロフィールを更新します
4. リクエストのレスポンスを確認し、エラーメッセージやデータベース情報が含まれているか確認します

## 対策方法
### 1. プリペアドステートメントの使用
```go
// 修正前（脆弱なコード）
query := "UPDATE users SET nickname = '" + profile.Nickname + "' WHERE id = '" + userID + "'"

// 修正後（安全なコード）
query := "UPDATE users SET nickname = ? WHERE id = ?"
_, err = db.Exec(query, profile.Nickname, userID)
```

### 2. 入力値のバリデーション
```go
func validateInput(input string) error {
    // 特殊文字や制御文字のチェック
    if strings.ContainsAny(input, "'\"\\;") {
        return errors.New("invalid characters in input")
    }
    return nil
}
```
