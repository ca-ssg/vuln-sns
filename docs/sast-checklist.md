# SAST診断チェックリスト

## インジェクション系攻撃

### SQLインジェクション
- [x] ログイン機能: backend/internal/handlers/auth.go:29-30
  - 脆弱性: fmt.Sprintf()を使用した文字列結合
  - 影響: 認証バイパス、データベース情報の漏洩
  - 対策: プリペアードステートメントの使用
- [x] 投稿作成機能: backend/internal/handlers/post.go:57
  - 脆弱性: fmt.Sprintf()を使用した文字列結合
  - 影響: 不正な投稿の作成、データベース操作
  - 対策: プリペアードステートメントの使用
- [x] 投稿更新機能: backend/internal/handlers/post.go:97
  - 脆弱性: fmt.Sprintf()を使用した文字列結合
  - 影響: 他ユーザーの投稿の改ざん
  - 対策: プリペアードステートメントの使用
- [x] 投稿削除機能: backend/internal/handlers/post.go:127
  - 脆弱性: fmt.Sprintf()を使用した文字列結合
  - 影響: 他ユーザーの投稿の削除
  - 対策: プリペアードステートメントの使用

### OSコマンドインジェクション
- [x] アバターアップロード機能: backend/internal/handlers/profile.go:136
  - 脆弱性: exec.Command()でのシェル実行
  - 影響: サーバー上での任意のコマンド実行
  - 対策: 入力値の検証とエスケープ、シェルを介さない実行

### ディレクトリトラバーサル
- [ ] ファイルアップロード機能（該当なし）
- [ ] 静的ファイル配信機能（該当なし）

### XSS（反射型・格納型・DOM型）
- [x] プロフィール表示機能: frontend/src/views/ProfileView.vue:12
  - 脆弱性: v-htmlディレクティブの使用
  - 影響: 悪意のあるスクリプトの実行、セッション盗取
  - 対策: v-textディレクティブの使用
- [x] 投稿表示機能: frontend/src/components/PostCard.vue:13
  - 脆弱性: v-htmlディレクティブの使用
  - 影響: 悪意のあるスクリプトの実行、他ユーザーへの攻撃拡散
  - 対策: v-textディレクティブの使用またはサニタイズ処理

### HTTPヘッダインジェクション
- [ ] レスポンスヘッダー設定（該当なし）
- [ ] リダイレクト処理（該当なし）

## 認証・認可制御

### 認可制御の欠落・バイパス
- [x] 認証トークンの露出: backend/internal/middleware/auth.go:18,23
  - 脆弱性: ログにトークンを出力
  - 影響: 認証情報の漏洩
  - 対策: センシティブ情報のログ出力禁止
- [x] 単純なトークン形式: backend/internal/handlers/auth.go:48
  - 脆弱性: userID_token形式の予測可能なトークン
  - 影響: トークンの推測、なりすまし
  - 対策: JWTなどの安全なトークン形式の採用

### パラメータ改ざんによる不正操作
- [x] 投稿の所有者チェック: backend/internal/handlers/post.go:90,120
  - 実装状況: 適切に実装済み（EXISTS句による確認）
  - 評価: 安全

### 不正ログイン検知・防御機能
- [ ] ブルートフォース攻撃対策（未実装）
- [ ] アカウントロック機能（未実装）
- [ ] ログイン試行回数制限（未実装）

### パスワード再設定フローの不備
- [ ] パスワード再設定機能（未実装）

### 不正会員登録防止機能
- [ ] 会員登録機能（未実装）

## セッション管理

### Cookie以外のセッション管理使用
- [x] localStorage使用: frontend/src/stores/auth.ts
  - 脆弱性: ブラウザストレージでの平文保存
  - 影響: XSSによるトークン盗取
  - 対策: セッションストレージの使用、HttpOnlyクッキーの採用

### セッションIDの推測可能性
- [x] 単純なトークン形式: userID_token
  - 脆弱性: 予測可能なトークン生成
  - 影響: セッションハイジャック
  - 対策: 暗号学的に安全な乱数の使用

### セッション有効期限・破棄処理
- [ ] トークン有効期限（未実装）
- [ ] 自動ログアウト機能（未実装）

### ログアウト機能の実装
- [ ] ログアウト機能（未実装）
- [ ] サーバーサイドでのセッション無効化（未実装）

### ドメイン横断セッション管理
- [ ] CORS設定（要確認）
- [ ] SameSite属性（該当なし）

### Cookie設定（有効期限・スコープ・不要Cookie）
- [ ] Cookieベースの認証（未使用）

### HttpOnlyフラグ設定
- [ ] Cookieベースの認証（未使用）

## 通信・暗号化

### 暗号化鍵長の適切性
- [x] パスワードハッシュ化: SHA2(password, 256)
  - 実装状況: SHA-256を使用
  - 評価: 適切（ただし、ソルトの使用を推奨）

### CookieのSecureフラグ
- [ ] Cookieベースの認証（未使用）

### HTTPS通信の強制
- [ ] HTTPS設定（要確認）
- [ ] HSTS設定（未実装）

## 情報漏洩対策

### エラー時の情報漏洩防止
- [x] パスワードのログ出力: backend/internal/handlers/auth.go:31
  - 脆弱性: SQLクエリにパスワードが含まれてログ出力
  - 影響: ログファイルからのパスワード漏洩
  - 対策: センシティブ情報のマスキング
- [x] SQLエラーの詳細表示
  - 実装状況: 適切にハンドリング済み
  - 評価: 安全

### バージョン情報の非表示
- [x] Dockerfileでのroot実行: backend/Dockerfile:15, frontend/Dockerfile:15
  - 脆弱性: root権限での実行
  - 影響: コンテナ侵害時の権限昇格
  - 対策: 非root権限での実行

### 重要ページのキャッシュ制御
- [ ] Cache-Controlヘッダー（要確認）
- [ ] Pragma: no-cacheヘッダー（要確認）

### セキュリティヘッダー設定
- [x] integrity属性不足: frontend/index.html:8-9
  - 脆弱性: 外部リソースの整合性検証なし
  - 影響: CDN改ざん時のXSS攻撃
  - 対策: integrity属性の追加
- [ ] X-Content-Type-Optionsヘッダー（未実装）
- [ ] X-Frame-Optionsヘッダー（未実装）
- [ ] Content-Security-Policyヘッダー（未実装）

## ファイルアップロード

### ファイル形式・サイズ制限
- [x] アバターアップロード: backend/internal/handlers/profile.go
  - 実装状況: Base64デコード処理のみ
  - 評価: ファイル形式・サイズ制限が不十分

### ファイル保存場所の安全性
- [x] 一時ファイル作成: backend/internal/handlers/profile.go:76-77
  - 実装状況: /tmp/avatarsディレクトリに保存
  - 評価: 一時ファイルは処理後に削除される

### ウィルススキャン
- [x] スキャン機能: backend/internal/handlers/profile.go:86
  - 脆弱性: OSコマンドインジェクション
  - 影響: 任意のコマンド実行
  - 対策: 安全なスキャン実装

## 入力値検証

### 文字種・長さ制限
- [ ] ユーザーID（要確認）
- [ ] パスワード（要確認）
- [ ] ニックネーム（要確認）
- [ ] 投稿内容（要確認）

### 数値範囲チェック
- [ ] 投稿ID（要確認）
- [ ] ページネーション（該当なし）

### 正規表現による検証
- [ ] メールアドレス（該当なし）
- [ ] URL形式（該当なし）

## ログ・監査

### アクセスログの記録
- [x] 認証ログ: backend/internal/middleware/auth.go
  - 実装状況: 認証試行をログ出力
  - 評価: 適切（ただし、センシティブ情報の除外が必要）

### セキュリティイベントの記録
- [ ] ログイン失敗（要確認）
- [ ] 権限エラー（要確認）
- [ ] 異常なアクセスパターン（未実装）

### ログの改ざん防止
- [ ] ログの署名（未実装）
- [ ] 外部ログサーバーへの転送（未実装）

## 設定・運用

### デフォルト設定の変更
- [ ] データベース認証情報（要確認）
- [ ] 管理者アカウント（該当なし）

### 不要なサービス・機能の無効化
- [ ] デバッグ機能（要確認）
- [ ] 開発用エンドポイント（要確認）

### 定期的なセキュリティ更新
- [ ] 依存関係の脆弱性チェック（要実装）
- [ ] セキュリティパッチの適用（要実装）

## 総合評価

### 高リスク脆弱性（即座に対応が必要）
1. SQLインジェクション（4件）
2. XSS（2件）
3. OSコマンドインジェクション（1件）

### 中リスク脆弱性（計画的に対応）
1. 認証トークンの露出（2件）
2. Dockerfile設定問題（2件）

### 低リスク脆弱性（時間があるときに対応）
1. integrity属性不足（2件）

### 推奨事項
1. プリペアードステートメントの全面的な導入
2. 出力エスケープの徹底
3. セキュリティヘッダーの設定
4. 定期的なSASTスキャンの実施
5. セキュリティ教育の実施
