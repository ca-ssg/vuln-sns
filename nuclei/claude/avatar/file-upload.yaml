id: vuln-sns-avatar-file-upload
info:
  name: Vuln SNS Avatar - File Upload Vulnerabilities
  author: claude
  severity: critical
  description: |
    Tests for file upload vulnerabilities in the avatar upload endpoint.
    Checks for unrestricted file types, size limits, and malicious file handling.
  reference:
    - https://owasp.org/www-community/vulnerabilities/Unrestricted_File_Upload
  tags: vuln-sns,file-upload,avatar,critical

variables:
  rand_str: "{{rand_base(8)}}"

http:
  - name: login
    method: POST
    path:
      - "{{BaseURL}}/api/login"
    headers:
      Content-Type: application/json
    body: |
      {"user_id":"alice","password":"alice"}
    extractors:
      - type: json
        name: token
        json:
          - '.token'
        internal: true

  - name: upload-php-file
    method: POST
    path:
      - "{{BaseURL}}/api/profile/avatar"
    headers:
      Content-Type: application/json
      Authorization: "Bearer {{token}}"
    body: |
      {
        "file_id": "malicious_{{rand_str}}.php",
        "image_data": "{{base64('<?php echo \"Malicious PHP executed\"; ?>')}}"
      }
    matchers-condition: or
    matchers:
      - type: word
        words:
          - "avatar_data"
          - "malware_scan"
        condition: and
        part: body
        name: php-file-accepted

      - type: word
        words:
          - ".php"
          - "<?php"
        condition: or
        part: body

  - name: upload-large-file
    method: POST
    path:
      - "{{BaseURL}}/api/profile/avatar"
    headers:
      Content-Type: application/json
      Authorization: "Bearer {{token}}"
    body: |
      {
        "file_id": "large_{{rand_str}}.jpg",
        "image_data": "{{base64(repeat('A', 1048576))}}"
      }
    matchers:
      - type: status
        status:
          - 200
          - 201
        name: large-file-accepted

  - name: upload-exe-file
    method: POST
    path:
      - "{{BaseURL}}/api/profile/avatar"
    headers:
      Content-Type: application/json
      Authorization: "Bearer {{token}}"
    body: |
      {
        "file_id": "malware_{{rand_str}}.exe",
        "image_data": "{{base64('MZ\\x90\\x00\\x03\\x00\\x00\\x00\\x04\\x00\\x00\\x00\\xff\\xff\\x00\\x00\\xb8\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x40\\x00\\x00\\x00')}}"
      }
    matchers:
      - type: word
        words:
          - "avatar_data"
        part: body
        name: exe-file-accepted

  - name: upload-polyglot-file
    method: POST
    path:
      - "{{BaseURL}}/api/profile/avatar"
    headers:
      Content-Type: application/json
      Authorization: "Bearer {{token}}"
    body: |
      {
        "file_id": "polyglot_{{rand_str}}.jpg",
        "image_data": "{{base64('\\xff\\xd8\\xff\\xe0\\x00\\x10JFIF\\x00\\x01\\x01\\x01\\x00H\\x00H\\x00\\x00<?php echo \"polyglot\"; ?>')}}"
      }
    matchers:
      - type: word
        words:
          - "avatar_data"
        part: body